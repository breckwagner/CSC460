<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_5hn7a0i6mj9t-6>li:before{content:"\0025cf  "}.lst-kix_5hn7a0i6mj9t-8>li:before{content:"\0025a0  "}.lst-kix_5hn7a0i6mj9t-5>li:before{content:"\0025a0  "}ul.lst-kix_5hn7a0i6mj9t-0{list-style-type:none}.lst-kix_5hn7a0i6mj9t-7>li:before{content:"\0025cb  "}ul.lst-kix_5hn7a0i6mj9t-4{list-style-type:none}ul.lst-kix_5hn7a0i6mj9t-3{list-style-type:none}ul.lst-kix_5hn7a0i6mj9t-2{list-style-type:none}.lst-kix_5hn7a0i6mj9t-0>li:before{content:"\0025cf  "}ul.lst-kix_5hn7a0i6mj9t-1{list-style-type:none}ul.lst-kix_5hn7a0i6mj9t-8{list-style-type:none}ul.lst-kix_5hn7a0i6mj9t-7{list-style-type:none}ul.lst-kix_5hn7a0i6mj9t-6{list-style-type:none}.lst-kix_5hn7a0i6mj9t-1>li:before{content:"\0025cb  "}ul.lst-kix_5hn7a0i6mj9t-5{list-style-type:none}.lst-kix_5hn7a0i6mj9t-2>li:before{content:"\0025a0  "}.lst-kix_5hn7a0i6mj9t-4>li:before{content:"\0025cb  "}.lst-kix_5hn7a0i6mj9t-3>li:before{content:"\0025cf  "}ol{margin:0;padding:0}table td,table th{padding:0}.c1{line-height:1.2;orphans:2;text-indent:36pt;widows:2}.c2{orphans:2;widows:2;height:11pt}.c4{page-break-after:avoid;orphans:2;widows:2}.c15{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c13{background-color:#ffffff;font-size:10pt;color:#167ac6}.c12{color:inherit;text-decoration:inherit}.c5{orphans:2;widows:2}.c6{color:#1155cc;text-decoration:underline}.c9{page-break-after:avoid;text-align:center}.c20{height:11pt}.c18{line-height:1.0}.c22{text-decoration:underline}.c7{text-indent:36pt}.c3{text-align:right}.c0{font-weight:bold}.c10{text-align:left}.c19{font-style:italic}.c17{height:16pt}.c16{font-size:11pt}.c11{text-align:center}.c21{height:14pt}.c8{line-height:1.2}.c14{font-size:10pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c15"><p class="c5 c18 c3"><span class="c0">Richard B. Wagner</span></p><p class="c5 c3 c18"><span class="c0">Navdeep Bahia</span></p><p class="c2 c3"><span></span></p><p class="c2 c3"><span></span></p><p class="c2 c3"><span></span></p><p class="c2 c9 title" id="h.bipr3ifozpck"><span></span></p><p class="c2 c9 title" id="h.d9lzy2mjgi3c"><span></span></p><p class="c2 c9 title" id="h.lvwxnuzdc9y7"><span></span></p><p class="c2 c9 title" id="h.180kn7tue3x9"><span></span></p><p class="c2 c9 title" id="h.sl2nj8e9y0n"><span></span></p><p class="c2 c9 title" id="h.mm6llbajiiu0"><span></span></p><p class="c4 c11 title" id="h.xxvmrrfl70tj"><span>CSC 460: Project Three</span></p><p class="c4 c11 subtitle" id="h.h3rfdxk8gour"><span>Laser Tank Game</span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><h1 class="c4" id="h.5xn8i0scje3o"><span>Introduction</span></h1><h2 class="c4" id="h.85odd42foyi7"><span>Objective</span></h2><p class="c1"><span>The main purpose of this project was to combine the work done in Projects One and Two in order to facilitate communication between two stations using Bluetooth and deploying tasks using a real time operating system (RTOS). &nbsp;There is a remote station that is placed on top of the &ldquo;tank&rdquo;, the Roomba 600, that receives input from a controller or base station. &nbsp;This controller can manually operate the tank&rsquo;s movements, toggle between manual and autonomous control, as well as fire the laser attached to the tank. &nbsp;The remote station possesses a light sensor that will halt the tank&rsquo;s movement when it gets hit, the aforementioned laser, and additional hardware for connecting to the Roomba. &nbsp;Both stations communicate via Bluetooth modules and each has an Arduino Mega 250 microcontroller which is used to control the various elements and run the software that provides the required functionality. &nbsp;</span></p><p class="c2 c8"><span></span></p><p class="c5 c8"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The elements from Project One that were re-implemented for this include the methods for Bluetooth communication, reading joystick inputs, toggling laser state remotely, as well as applying some of the techniques used in understanding the TTA scheduler to make full use of the RTOS. &nbsp;While the original methods of implementation were done in the Arduino IDE, this project required translating all of that into C code. &nbsp;From Project 2, the RTOS implementation was used to launch the various tasks that are required to start up and control the tank, along with the other various functions, including polling the sensors and controlling the other hardware elements.</span></p><h2 class="c4 c8" id="h.iuwa74xyayz4"><span>Project Phases and Report Structure</span></h2><p class="c1"><span>The </span><span class="c0">Process and Design </span><span>section details the design and setup of the hardware needed for the two stations. &nbsp;It also contains a detailed description, diagrams, and explanation of the code of the two main phases of this project. &nbsp;</span><span>Phase One required the implementation of manual control of the Roomba, along with the ability to fire the laser and have the light sensor detect when it has been struck. &nbsp;The details of the implementation of this phase can be found in the </span><span class="c0">Phase 1 </span><span>subsection. &nbsp;Phase Two required autonomous behaviour be added to the design so that the tank can roam and avoid obstacles without user input. &nbsp;The details can be found in the </span><span class="c0">Phase 2 </span><span>subsection.</span></p><p class="c1 c20"><span></span></p><p class="c1"><span>The </span><span class="c0">Source Code </span><span>section contains a link to the Github repository where the code for this project can be found. &nbsp;</span><span class="c0">Results </span><span>details the end product of this project, while </span><span class="c0">Debugging </span><span>lists the various methods that were used to analyze and fix the problems that were encountered. &nbsp;</span><span class="c0">Testing</span><span>&nbsp;has screenshots of the output of the logic analyzer to show how the system was tested, and </span><span class="c0">Obstacles </span><span>outlines the struggles this project faced. Finally, </span><span class="c0">References </span><span>contains credit given to code bases that were borrowed from as well as a few key pieces of documentation.</span></p><h2 class="c4" id="h.tsqawmcd1kb9"><span>Hardware</span></h2><p class="c5 c8"><span>The following is a list of the hardware used in both phases of the project:</span></p><p class="c2"><span></span></p><p class="c5"><span>1 x iRobot Roomba 600 </span></p><p class="c5 c8"><span>2 x Arduino Mega 2560 Microcontrollers</span></p><p class="c5 c8"><span>2 x Bluetooth Radio HC-05/06</span></p><p class="c5 c8"><span>1 x Arduino KY-023 XY-axis Joystick Module</span></p><p class="c5 c8"><span>1 x SG-90 Tower Pro Servo Motor</span></p><p class="c5 c8"><span>1 x KY-008 Arduino Laser Module</span></p><p class="c5 c8"><span>1 x Analog Light Sensor/Photocell</span></p><p class="c5 c8"><span>1 x 2N3904 NPN Power MOSFET Transistor</span></p><p class="c5 c8"><span>1 x &nbsp;LCD Keypad Shield Display</span></p><p class="c5 c8"><span>1 x 10 &#13248; Resistor</span></p><p class="c5 c8"><span>2 x Breadboards</span></p><p class="c5 c8"><span>1 x Red Plastic Cup</span></p><p class="c2 c8"><span></span></p><h1 class="c4" id="h.nin68zbd7cn5"><span>Process and Design</span></h1><h2 class="c4" id="h.3ked1r4f42hq"><span>Remote and Base Station: Hardware</span></h2><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There are two major components in this system: the </span><span class="c0">base station</span><span>, which acts as a manual controller, and the </span><span class="c0">remote station</span><span>&nbsp;that sits on top of the Roomba. &nbsp;The base station consists of an Arduino Mega 2560 microcontroller, the joystick that a user can manually control the Roomba&rsquo;s movement with and fire the laser, as well as a Bluetooth module to communicate with the remote station. &nbsp;The remote station also makes use of an Arduino Mega 2560 microcontroller and Bluetooth module to communicate with the base station. &nbsp;It also contains the light sensor, placed on a wooden base in the red plastic cup, the laser,and a servo motor which the laser is attached to. The various components of both these stations are affixed to sheets of plexiglass with strips of velcro for ease of transportation and attachment.</span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><h3 class="c4 c21" id="h.9j7hit9a2ih7"><span></span></h3><h3 class="c4" id="h.87aazu90qb18"><span>Wiring Diagrams</span></h3><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 502.99px; height: 652.11px;"><img alt="" src="images/image16.png" style="width: 502.99px; height: 652.11px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 1: Wiring Diagram of Base Station </span></p><p class="c2 c10"><span class="c0 c14"></span></p><p class="c2 c10"><span class="c0 c14"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 776.00px;"><img alt="" src="images/image08.png" style="width: 624.00px; height: 776.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 2: Wiring Diagram of Remote Station</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c10"><span>Please note that the servo attachment is from Project One, it doesn&rsquo;t serve any purpose in this project except to act as convenient mount for the laser.</span></p><p class="c2 c10"><span></span></p><h3 class="c4" id="h.30d2tjnczw0t"><span>Images</span></h3><p class="c2"><span></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 350.67px;"><img alt="" src="images/image05.jpg" style="width: 624.00px; height: 350.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 3: Base Station</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 350.67px;"><img alt="" src="images/image01.jpg" style="width: 624.00px; height: 350.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 4: Remote Station</span></p><p class="c2"><span></span></p><p class="c5"><span>Please note that in the above image, the breadboard has been attached to the top of the Arduino Mega 250 microcontroller.</span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 350.67px;"><img alt="" src="images/image11.jpg" style="width: 624.00px; height: 350.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 5: Remote Station Connected on Top of Roomba</span></p><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 350.67px;"><img alt="" src="images/image00.jpg" style="width: 624.00px; height: 350.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 6: Bottom of Light Sensor Setup</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c2 c11"><span class="c0"></span></p><h2 class="c4" id="h.jkil5zo3wdek"><span>Remote and Base Station: Overall System Design</span></h2><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The following is a block diagram that depicts the major elements of both the base and remote station. &nbsp;It visualizes how the components in each station communicates with each other and the other station. &nbsp; This diagram will be further decomposed in later sections.</span></p><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 439.56px; height: 637.50px;"><img alt="" src="images/image02.png" style="width: 439.56px; height: 637.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 7: Overall System Design</span></p><p class="c2 c11"><span class="c0"></span></p><h2 class="c4" id="h.awbhjo3us5tj"><span>Phase 1: Manual Control of Roomba</span></h2><p class="c5 c7"><span>This phase of the project entailed using the base station to communicate with the remote setup on top of the Roomba in order to facilitate manual control of the Roomba&rsquo;s movements by the user. &nbsp;It was also required that it must be possible to fire the laser attached to the remote &nbsp;station from the base, and that the light sensor be calibrated such that the detection of laser light stops the motion of the Roomba. &nbsp;The code for this manual control had to make use of the real time operating systems that were designed and implemented in Project Two. &nbsp;However, since the RTOS designed by this group had missing functionality, a working RTOS design was borrowed from a different group. &nbsp;Their work is credited in the </span><span class="c0">References</span><span>&nbsp;section at the end of this report. &nbsp;A note about the UART channels: UART1 and UART2 are used to communicate between the stations, among the components, and the Roomba, while UART0 is used in conjunction with the serial monitor in the Arduino IDE for debugging purposes.</span></p><p class="c2"><span></span></p><h3 class="c4" id="h.5yrwa3obn3b3"><span>Block Diagram</span></h3><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This is the diagram depicting the interaction among the tasks between the two stations for the implementation of the manual control. &nbsp;The arrows indicate the ways the components and functions interact, including RTOS function calls. </span></p><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 833.33px;"><img alt="" src="images/image14.png" style="width: 624.00px; height: 833.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 8: Block Diagram of Phase 1</span></p><p class="c2 c11"><span class="c0"></span></p><h3 class="c4" id="h.g6t347oqcy1i"><span>Code</span></h3><h4 class="c4" id="h.1hwtl12mcvit"><span>Libraries</span></h4><p class="c5 c7"><span>The code for the two stations is supported by three libraries: </span><span class="c0">avr-uart, roomba-lib, </span><span>and </span><span class="c0">rtos. &nbsp;</span><span>All of these can be found in the project_3/src/</span><span class="c0">lib </span><span>folder. &nbsp;</span><span class="c0">Avr-uart </span><span>contains functions that assist with reading values from and writing values to the UART connections established between the two stations. &nbsp;</span><span class="c0">Roomba-lib </span><span>contains functions for testing for valid Roomba commands and a </span><span class="c19">massive</span><span>&nbsp;header file (</span><span class="c0">roomba.h</span><span>) that contains multiple structs pertaining to Roomba operation codes, sensor packets, and the definitions of various useful constants. &nbsp;</span><span class="c0">Rtos </span><span>contains the RTOS implementation (i.e </span><span class="c0">os,h, cswitch.S, </span><span>etc). </span></p><h4 class="c4" id="h.g3o0pb9pa41z"><span>Base Station</span></h4><p class="c5 c7"><span>The code for base station can be found in the folder </span><span class="c0">basestation </span><span>in the file </span><span class="c0">main.c. &nbsp;</span><span>The following is an explanation of the main functions of this code, as seen on </span><span class="c0">Figure 8</span><span>&nbsp;above. &nbsp;</span><span class="c0">&nbsp;</span></p><p class="c2 c7"><span class="c0"></span></p><p class="c2 c7 c11"><span class="c0"></span></p><p class="c5 c7 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 364.00px; height: 243.68px;"><img alt="" src="images/image21.png" style="width: 364.00px; height: 243.68px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c7 c11"><span class="c0">Figure 9: a_main() in basestation/main.c</span></p><p class="c2"><span></span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c5 c7"><span class="c0">a_main()</span><span>&nbsp;is responsible for initializing various analog and digital pins, before calling adc_init(), a function that is explained further down in the report. &nbsp;It also initializes communication with Roomba by calling </span><span class="c0">uartx_init(), </span><span>functions from the uart library, with appropriate baud rate and then creating both the idle task and the pole_sensors task using RTOS functions before terminating.</span></p><p class="c2 c7"><span></span></p><p class="c2 c7"><span></span></p><p class="c2 c7"><span></span></p><p class="c2 c7"><span></span></p><p class="c5 c7 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 437.92px; height: 156.50px;"><img alt="" src="images/image15.png" style="width: 437.92px; height: 156.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c7 c11"><span class="c0">Figure 10: adc_init() in basestation/main.c</span></p><p class="c2"><span class="c0"></span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adc_init() </span><span>opens up the channels for communication among the various hardware components on the base station, like the joystick.</span></p><p class="c2"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 108.00px;"><img alt="" src="images/image06.png" style="width: 624.00px; height: 108.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c7 c11"><span class="c0">Figure 11: read_adc() in basestation/main.c</span></p><p class="c2"><span class="c0"></span></p><p class="c5 c10"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">r</span><span class="c0">ead_adc()</span><span>&nbsp;is used in conjunction with analog pin numbers to read input from the joystick and other devices in different parts of the code base. </span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 368.50px; height: 536.81px;"><img alt="" src="images/image19.png" style="width: 368.50px; height: 536.81px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 11: pole_sensors() in basestation/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">pole_sensors()</span><span>&nbsp;is responsible for the bulk of the work done by the basestation. &nbsp;It initializes communication along UART1 with the correct baud rate to maintain ongoing contact with the Roomba and along the Bluetooth connection (UART0 is used for debugging and explained in the relevant part of the report). &nbsp;It also takes in input from the X- and Y-axes of the joystick before performing the calculations necessary to convert them into the correct range for radius and velocity respectively. &nbsp;Further on in the function, these values are split into two bytes and passed along UART1 to the remote station. &nbsp;pole_sensors() also takes in the value of the joystick button for triggering the laser on the remote station as well. &nbsp;Sending a value of </span><span class="c0">1 </span><span>prior to transmitting these inputs informs the remote station that input is incoming. &nbsp;Sending a </span><span class="c0">5 </span><span>prior to the velocity and radius values informs that manual drive commands will be arriving. &nbsp;Sending a </span><span class="c0">3 </span><span>prior to the joystick values informs that a laser state will be arriving.</span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 406.00px; height: 34.22px;"><img alt="" src="images/image18.png" style="width: 406.00px; height: 34.22px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 12: LOW_BYTE and HIGH_BYTE definitions</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When accepting manual drive commands, the Roomba splits the radius and velocity inputs into high and low bytes as defined in </span><span class="c0">FIgure 12</span><span>. &nbsp;These bytes are then converted to using hex and 2&rsquo;s complement by the Roomba before movement takes place.</span></p><p class="c2 c11"><span></span></p><h4 class="c4" id="h.p10sirku7pbf"><span>Remote Station</span></h4><p class="c2"><span></span></p><p class="c5 c7"><span>The code for the remote station can be found in the folder </span><span class="c0">remotecontroller </span><span>in the file </span><span class="c0">main.c. &nbsp;</span><span>The following is an explanation of the main functions of this code, as seen on </span><span class="c0">Figure 8</span><span>&nbsp;above. &nbsp; </span></p><p class="c2 c7"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 314.50px; height: 397.03px;"><img alt="" src="images/image20.png" style="width: 314.50px; height: 397.03px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span>&nbsp;</span></p><p class="c5 c11"><span class="c0">Figure 13: a_main() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c2"><span></span></p><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c0">a_main() </span><span>initializes the ports and pins used by the device detect pin (DD_PIN) that is used to upload code from the remote station&rsquo;s Arduino microcontroller to the Roomba. &nbsp;It also creates a task that will call on roomba_init() before terminating. </span></p><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 270.00px; height: 413.50px;"><img alt="" src="images/image13.png" style="width: 270.00px; height: 413.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 14: roomba_init() in remotecontroller/main.c</span></p><p class="c2"><span class="c0"></span></p><p class="c5 c7"><span class="c0">roomba_init() &nbsp;</span><span>begins communication with the Roomba over the DD_Pin using the appropriate baud rate. &nbsp;The function sleeps for 200ms to give the machine a chance to &ldquo;wake up&rdquo; and come online. &nbsp;The Roomba is then put into Safe mode for the purposes of this project. &nbsp;Then, the function creates a call to the layer_1() function (more on that in Phase 2) which calls the handle_radio() function detailed below. &nbsp;roomba_init() then creates a task to run the pole_sensors() function before terminating.</span></p><p class="c2 c10"><span></span></p><p class="c5 c7 c10"><span>This main.c also makes use of the adc_init() and read_adc() functions as described in the base station portion of the report. </span></p><p class="c2 c10"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 291.00px; height: 398.82px;"><img alt="" src="images/image17.png" style="width: 291.00px; height: 398.82px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 15: handle_radio() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c7"><span class="c0">handle_radio() </span><span>makes use of the Mutex locks in the RTOS to gather inputs over UART and then parse them to the appropriate functions. </span></p><p class="c2 c7"><span></span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 348.50px; height: 212.52px;"><img alt="" src="images/image23.png" style="width: 348.50px; height: 212.52px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 16: update_roomba_state() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c7"><span>This function uses the Roomba operation codes to query its sensors over UART. &nbsp;The exact numbers of these codes can be found in the header file </span><span class="c0">roomba.h. &nbsp;</span></p><p class="c2 c10"><span class="c0"></span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 488.00px; height: 327.79px;"><img alt="" src="images/image07.png" style="width: 488.00px; height: 327.79px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 17: pole_sensors() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pole_sensors() </span><span>contains code to manipulate the Roomba&rsquo;s onboard LCD display. &nbsp;It also reads the input from the light sensor and triggers the stop function when a certain threshold has been met. </span></p><p class="c2"><span></span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 240.00px; height: 75.28px;"><img alt="" src="images/image03.png" style="width: 240.00px; height: 75.28px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 18: toggle_laser() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;toggle_laser() </span><span>does just that by writing certain values to the port that the laser is connected to depending on the value that was received from the base station. </span></p><p class="c2"><span></span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 218.00px; height: 95.14px;"><img alt="" src="images/image04.png" style="width: 218.00px; height: 95.14px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 19: roomba_stop() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c10"><span class="c0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>This function stops the Roomba&rsquo;s movements when the light sensor is triggered by sending the required operation codes over UART.</span></p><h2 class="c4 c17" id="h.clahpeyk7wue"><span></span></h2><h2 class="c4" id="h.xvay2pyk46ep"><span>Phase 2: Addition of Autonomous Behaviour </span></h2><h3 class="c4" id="h.i0yf04icf59h"><span>Description of Architecture</span></h3><p class="c2"><span></span></p><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The original design of this phase was to go straight and execute a turn when obstacles were encountered. The code below (</span><span class="c0">Figure 20</span><span>) shows the code that was used initially for turning. The same idea is done in the final version with the difference of the data being retrieved in a separate routine (</span><span class="c0">Figure 21</span><span>). </span></p><p class="c2 c10"><span></span></p><p class="c2"><span></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 337.50px; height: 473.86px;"><img alt="" src="images/image10.png" style="width: 337.50px; height: 473.86px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 20: roomba_turn() in remotecontroller/main.c</span></p><p class="c2 c11"><span class="c0"></span></p><p class="c5 c11"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 328.00px; height: 333.78px;"><img alt="" src="images/image12.png" style="width: 624.14px; height: 351.00px; margin-left: -30.34px; margin-top: -17.22px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 21: autonomous() function</span></p><p class="c2"><span></span></p><h3 class="c4" id="h.wkakrvcl7gji"><span>Demonstration</span></h3><p class="c5"><span>Phase I &nbsp;Demo: </span><span class="c13 c22"><a class="c12" href="https://www.google.com/url?q=https://youtu.be/E7pXw85mCic&amp;sa=D&amp;ust=1459922622659000&amp;usg=AFQjCNF5Ft86PWxww228QN1-k_OZFEzPuQ">https://youtu.be/E7pXw85mCic</a></span></p><p class="c5"><span>Phase II Demo: </span><span class="c13"><a class="c12" href="https://www.google.com/url?q=https://youtu.be/hDM3rV1CkMw&amp;sa=D&amp;ust=1459922622660000&amp;usg=AFQjCNEiHcynoWgcI6rVRUz-cuv6621MxA">https://youtu.be/hDM3rV1CkMw</a></span></p><h1 class="c4" id="h.vfpvz8ttvqxa"><span>Results: Final Design</span></h1><p class="c5"><span>Roomba Interface Documentation: </span></p><p class="c5"><span class="c6"><a class="c12" href="https://www.google.com/url?q=http://breckwagner.github.io/CSC460/project_3/documentation/html/group__roomba-lib.html&amp;sa=D&amp;ust=1459922622661000&amp;usg=AFQjCNHz4OCW2pg8lLrHd-8zRYM6J6e3hQ">http://breckwagner.github.io/CSC460/project_3/documentation/html/group__roomba-lib.html</a></span></p><p class="c2"><span></span></p><h1 class="c4" id="h.w1yg1m89ukli"><span>Source </span><span>Code</span></h1><p class="c5"><span class="c6"><a class="c12" href="https://www.google.com/url?q=https://github.com/breckwagner/CSC460/archive/0.1.zip&amp;sa=D&amp;ust=1459922622663000&amp;usg=AFQjCNHveWbT2anOTKu41eEdq1lPZ5YS7w">https://github.com/breckwagner/CSC460/archive/0.1.zip</a></span></p><h1 class="c4" id="h.dmj6suampzvr"><span>Debugging</span></h1><p class="c2"><span></span></p><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;There were several methods that were used to debug issues that arose during the implementation of this project. &nbsp;The logic analyzer was the tool of choice to initially diagnose a problem. &nbsp;Using it makes it possible to determine what values are being sent over UART, when the RTOS deploys tasks, when Roomba returns sensor packets after receiving a query request, etc. In the screenshot of the logic analyzer below, it shows that the approximate time between the Roomba receiving a request and then responding and sending the data that was requested back is about 15 ms. &nbsp;Information like this is useful when trying to determine the cause of delays from software and hardware. &nbsp; </span></p><p class="c2"><span></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 332.00px;"><img alt="" src="images/image22.jpg" style="width: 624.00px; height: 332.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 22: Logic Analyzer Screenshot</span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c5 c7"><span>Code in the pole_sensors() function was used to print to the serial monitor associated with the Arduino IDE using UART0. &nbsp;This was done to ensure that was data was actually being sent across the Bluetooth connection and then determining what the values being sent across were actually accurate.</span></p><p class="c2"><span></span></p><p class="c5"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 69.33px;"><img alt="" src="images/image09.png" style="width: 624.00px; height: 69.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c5 c11"><span class="c0">Figure 23: Code Snippet for Debugging Using UART0</span></p><p class="c2 c11"><span></span></p><p class="c2"><span></span></p><p class="c5 c7"><span>There were times when neither of the aforementioned methods worked and it difficult to discern what was truly wrong. &nbsp;When this happened, simple trial and error was used to find the cause of errors. &nbsp;This resulted in discovering faulty wires, loose pins, and that the joystick button required a pull up resistor to work properly, among other things.</span></p><p class="c2 c7"><span></span></p><h1 class="c4" id="h.14cs7juqtif0"><span>Testing</span></h1><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Testing the Roomba was done using the logic analyzer as described above; determining whether sensor packets were being sent and received correctly was the primary reason for doing this. &nbsp;After this, testing was primarily done uploading code to the Arduino microcontrollers and seeing what happened. &nbsp;This proved useful as it was difficult to figure out if the code was working as it should or if the Roomba data behaved as it was stated in the documentation without trying things. &nbsp; </span></p><h1 class="c4" id="h.iaobmiwmki87"><span>Obstacles</span></h1><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Aside from the aforementioned difficulties the in Debugging and Testing sections, there were a few other obstacles that were encountered. &nbsp;First, since this group didn&rsquo;t have a properly functioning RTOS implementation, the work posted by the classmates in the </span><span class="c0">References</span><span>&nbsp;section was used. &nbsp;It took some time to understand how their code was organized and how it operated. &nbsp;There was also some problems encountered with data types, as preserving accuracy meant more data was being sent over connections which yielded slow communication. &nbsp;It was also found that the Roomba sensors were subject to sensor drift, which often skewed calculations and potential solutions to other bugs in the code. &nbsp;</span></p><p class="c2"><span></span></p><p class="c5 c7"><span>There were several issues with the Roombas as well. &nbsp;Sometimes, the sensor values that were returned were completely random and the cause of this was never found out. &nbsp;Interfacing the Arduino boards with the Roomba also lent itself to strange behaviour in terms of movement. &nbsp;No cause for that behaviour could be found in the code or the data transmission. &nbsp;It may have been an issue with the wiring of the connector cable. </span></p><p class="c2 c7"><span></span></p><p class="c5 c7"><span>The Bluetooth modules would often get out of sync and they had to be re-configured on a couple of separate occasions. &nbsp;</span></p><h1 class="c4" id="h.y6ny46j8upg4"><span>References</span></h1><p class="c5"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The RTOS code for this project was the implementation created by Chris Cook and Kevin Gill. &nbsp;It can be found on their project website at: </span></p><p class="c2"><span></span></p><p class="c5"><span class="c6"><a class="c12" href="https://www.google.com/url?q=http://www.roombatank.com/index.html&amp;sa=D&amp;ust=1459922622671000&amp;usg=AFQjCNGP28Pkdq0OurYsh7gjzEeS5CS8nw">http://www.roombatank.com/index.html</a></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p><p class="c2"><span></span></p></body></html>